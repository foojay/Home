---
layout: post
title:  "Java 调用Dll"
date:   2016-10-12 15:14:54
categories: java
excerpt: Java 调用Dll
---

* content
{:toc}


### JAVA中所需要做的工作 

　在JAVA程序中，首先需要在类中声明所调用的库名称，如下：
<pre>
    public class TestDll {
    static { System.loadLibrary("TestDLL"); }
    public native static int get(); 
    public native static void set(int i);
    public static void main(String[] args) 
    { 
        TestDll test = new TestDll(); 
        test.set(10);
        System.out.println(test.get()); } 
    }
</pre>


在这里，库的扩展名字可以不用写出来，究竟是DLL还是SO，由系统自己判断。还需对将要调用的方法做本地声明，关键字为native。且只需要声明，而不需要具体实现。如下： 


<pre>
    public native static void set(int i); public native static int get();
</pre>

然后编译该java程序文件，生成class，再用javah命令，JNI就会生成C/C++的头文件。



例如程序testdll.java，内容为：

<pre>
    public class testdll { 

    static { System.loadLibrary("goodluck"); } 

    public native static int get(); public native static void set(int i); 

    public static void main(String[] args) { 

    testdll test = new testdll(); test.set(10); 

    System.out.println(test.get()); 

    }

 }
</pre>


用javac testdll.java编译它，会生成testdll.class。再用javah testdll则会在当前目录下生成testdll.h文件，这个文件需要被C/C++程序调用来生成所需的库文件。


### C/C++中所需要做的工作 　　

  对于已生成的.h头文件，C/C++所需要做的，就是把它的各个方法具体的实现。然后编译连接成库文件即可。再把库文件拷贝到JAVA程序的路径下面，就可以用JAVA调用C/C++所实现的功能了。接上例子。我们先看一下testdll.h文件的内容： 


  <pre>
          /* DO NOT EDIT THIS FILE - it is machine generated */
        #include "jni.h"
        /* Header for class TestDll */

        #ifndef _Included_TestDll
        #define _Included_TestDll
        #ifdef __cplusplus
        extern "C" {
        #endif
            /*
            * Class:     TestDll
            * Method:    get
            * Signature: ()I
            */
            JNIEXPORT jint JNICALL Java_TestDll_get
                (JNIEnv *, jclass);

            /*
            * Class:     TestDll
            * Method:    set
            * Signature: (I)V
            */
            JNIEXPORT void JNICALL Java_TestDll_set
                (JNIEnv *, jclass, jint);

        #ifdef __cplusplus
        }
        #endif
        #endif
  </pre>



在具体实现的时候，我们只关心两个函数原型 　　
JNIEXPORT jint JNICALL Java_testdll_get (JNIEnv *, jclass); 和 　　
JNIEXPORT void JNICALL Java_testdll_set (JNIEnv *, jclass, jint); 　　
这里JNIEXPORT和JNICALL都是JNI的关键字，表示此函数是要被JNI调用的。而jint是以JNI为中介使JAVA的int类型与本地的int沟通的一种类型，我们可以视而不见，就当做int使用。函数的名称是JAVA_再加上java程序的package路径再加函数名组成的。参数中，我们也只需要关心在JAVA程序中存在的参数，至于JNIEnv*和jclass我们一般没有必要去碰它。好，下面我们用testdll.cpp文件具体实现这两个函数： 

<pre>
    
    #include "testdll.h" 

    int i = 0; 

    JNIEXPORT jint JNICALL Java_testdll_get (JNIEnv *, jclass)
     { 
    return i; 
     } 

    JNIEXPORT void JNICALL Java_testdll_set (JNIEnv *, jclass, jint j) 
    { 
    i = j; 
    }

</pre>

编译连接成库文件，本例是在WINDOWS下做的，生成的是DLL文件。并且名称要与JAVA中需要调用的一致，这里就是goodluck.dll 。把goodluck.dll拷贝到testdll.class的目录下，java testdll运行它，就可以观察到结果了。 


### 说明

将TestDLL.h中的内容复制到vc++项目的TestDLL.h的中。在TestDLL.h 的头文件中包含了jni.h头文件，所以需要将jdk安装目录下include文件夹下的jni.h头文件和include\win32文件夹下的jawt_md.h和jni_md.h头文件拷贝到visual studio的安装目录下vc\include文件夹下。我的路径是：C:\Program Files\Microsoft Visual Studio 9.0\VC\include

也可以把jdk下的那三个头文件拷贝到vc++的项目目录下，我的项目目录路径是：

C:\Users\wangzw\Documents\Visual Studio 2008\Projects\face\face，如果是拷贝到了项目的路径下的话，就需要将TestDLL.h头文件中的#include <jni.h>改为#include “jni.h”

拷贝生成的dll文件 到jdk/bin目录下

### 参考文献
 * [Java: JNI完全手册](http://pcedu.pconline.com.cn/empolder/gj/java/0506/642328.html)
 * [Green.Face](http://www.cnblogs.com/gnface/archive/2012/09/20/2695872.html)
 * [360doc](http://www.360doc.com/content/11/0609/19/1861654_122741977.shtml)


